name: Custom project CI/CD

on:
  push:
    branches:
      - orchid_dev
      - main

  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Restore file mtimes from Git history
        uses: chetan/git-restore-mtime-action@v2.2

      - name: Force update timestamps for critical files
        run: |
          touch config/environment.php
          touch views/templates/*.php
          sleep 1

      - name: Determine deploy settings
        id: set_remote
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF##*/}"
          echo "Branch: $BRANCH"

          if [[ "$BRANCH" == "orchid_dev" ]]; then
            # Staging: deploy to /public_html/staging/
            REMOTE_DIR_VAL="/public_html/staging/"
            LOCAL_SRC_VAL="."
          else
            # Production (main): deploy to /public_html/
            REMOTE_DIR_VAL="/public_html/"
            LOCAL_SRC_VAL="."
          fi

          echo "REMOTE_DIR=$REMOTE_DIR_VAL" >> "$GITHUB_ENV"
          echo "LOCAL_SRC=$LOCAL_SRC_VAL" >> "$GITHUB_ENV"
          echo " â†’ Deploying $LOCAL_SRC_VAL to $REMOTE_DIR_VAL"

      - name: Add remote host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          FTP_HOST="${{ secrets.FTP_HOST }}"
          SSH_PORT="${{ secrets.SSH_PORT }}"
          if [ -z "$SSH_PORT" ]; then
            ssh-keyscan -H "$FTP_HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H -p "$SSH_PORT" "$FTP_HOST" >> ~/.ssh/known_hosts
          fi
          chmod 644 ~/.ssh/known_hosts
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8

      - name: Install lftp
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp

      - name: Deploy with lftp
        shell: bash
        run: |
          set -euo pipefail

          FTP_HOST="${{ secrets.FTP_HOST }}"
          FTP_USER="${{ secrets.FTP_USER }}"
          FTP_PASS="${{ secrets.FTP_PASS }}"
          SSH_PORT="${{ secrets.SSH_PORT }}"
          SFTP_PROTOCOL="${{ secrets.SFTP_PROTOCOL }}"

          if [[ -z "$SFTP_PROTOCOL" ]] || [[ "$SFTP_PROTOCOL" == "sftp" ]]; then
            PROTO="sftp"
          else
            PROTO="$SFTP_PROTOCOL"
          fi

          if [[ -z "$SSH_PORT" ]]; then
            TARGET="${PROTO}://${FTP_HOST}"
          else
            TARGET="${PROTO}://${FTP_HOST}:${SSH_PORT}"
          fi

          if [[ -z "${REMOTE_DIR:-}" ]]; then
            echo "ERROR: REMOTE_DIR is not set!"
            exit 1
          fi

          echo "Uploading ${LOCAL_SRC} to: ${TARGET}${REMOTE_DIR}"

          lftp -u "$FTP_USER","$FTP_PASS" \
            -e "set ssl:verify-certificate no; \
                set sftp:connect-program 'ssh -a -x -o UserKnownHostsFile=~/.ssh/known_hosts -o StrictHostKeyChecking=yes'; \
                lcd ${LOCAL_SRC}; \
                cd ${REMOTE_DIR}; \
                mirror -R --parallel=3 --verbose \
                  --exclude .git/ \
                  --exclude .github/ \
                  --exclude .claude/ \
                  --exclude node_modules/ \
                  --exclude tests/ \
                  --exclude vendor/ \
                  --exclude docs/ \
                  --exclude .env \
                  --exclude .env.example \
                  --exclude .gitignore \
                  --exclude README.md \
                  --exclude 'storage/logs/*' \
                . .; \
                bye" "$TARGET"
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
